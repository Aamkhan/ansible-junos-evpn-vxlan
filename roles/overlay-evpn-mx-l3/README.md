
# 'overlay-evpn-mx-l3' role
Generate configuration for EVPN/VXLAN for MX in L3 mode (w/ IRB)
 - Overlay iBGP configuration
 - L2 and L3 VRF per tenant
 - VNI/VLAN creation with associated policy options
 - IRB per VLAN/VNI (Optional)
 - Route reflector (Optional)

Template can be found in [overlay-evpn-mx-l3/templates/main.conf.j2](templates/main.conf.j2)

## Variables needed by the template

```yaml
# Global parameters
build_dir:            # Repository used save config generated by this role

# Per device parameters
loopback_ip:          # Loopback ip in the defaul VRF, used as VTEP address

overlay:
    local:
        asn: 				  # Local AS to build control plane of EVPN
    neighbors: 				# List of IP address to configure BGP sessions. Must be RR if you are on leaves and must be leaves if you are on MXs. In any case, it must be loopback of devices
    rr_bgp: 				      # List of all route reflector -- ONLY for MXs / not supported for leaves
    local_ip:             # Last digit of the IP address used to generate local IP in each VNI
    tenants:
      <tenant_A_name>:
        lo0_ip:           # Loopback IP per tenant's VRF
        id: 				      # ID of the tenant
        bridge_domains:		# List all Bridge domains / vlan / vni
        - vlan_id: 		    # Vlan ID of the first bridge domain
          vni_id: 		    # VNI associated to this vlan
          network:  	    # Physical IP address of the IRB -- ONLY for L3 devices
          mask: 			     # Netmask of the IRB -- ONLY for L3 devices

# Default parameters
    bfd:
      min_interval:
      multiplier:
      mode:
```

### Example

This template have been designed to used a variable structure mainly composed of hash/dict.  
Leveraging Ansible option to *merge hash*, it become possible to have all required information coming from different variable files, in order to reduce data duplication.

- group_vars/*group_name*/overlay.yaml   > Information shared across devices
- host_vars/*device_name*/overlay.yaml   > information specific to single device

**For Group 'all'**
```yaml
# group_vars/all/overlay.yaml
overlay:
    vip_ip: 1
    tenants:
      tenant10:
        id: 10
        bridge_domains:
        - vlan_id: 100
          vni_id: 1000
          network: 10.1.100.
          mask: 24
        - vlan_id: 101
          vni_id: 1001
          network: 10.1.101.
          mask: 24
      tenant20:
        id: 20
        bridge_domains:
        - vlan_id: 105
          vni_id: 1005
          network: 10.1.105.
          mask: 24
        - vlan_id: 106
          vni_id: 1006
          network: 10.1.106.
          mask: 24
```

**For Device 'mx480-01'**
```yaml
# host_vars/mx480-01/overlay.yaml
overlay:
    local:
        cluster: 2.2.2.2
    local_ip: 212
    rr_bgp: [ 100.0.0.11, 100.0.0.13, 100.0.0.14 ]
    neighbors: [ 100.0.0.21, 100.0.0.22 ]
    tenants:
      tenant10:
        lo0_ip: 100.10.0.12
      tenant20:
        lo0_ip: 100.20.0.12
```

## How to Enable Merge Hash in Ansible

In the root directory of your project, create a file name ```ansible.cfg``` and add :
```
[defaults]
hash_behaviour=merge
```
